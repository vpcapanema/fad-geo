<!-- BACKUP GERADO AUTOMATICAMENTE EM 05/06/2025 -->
<!DOCTYPE html>
<html lang="pt-br">
<head>  <meta charset="UTF-8">
  <title>Cadastro - Usu√°rio</title>
  <link rel="stylesheet" href="/static/css/componentes/fad_header.css">
  <link rel="stylesheet" href="/static/css/cd_usuario/cd_cadastro_usuario.css">
  <link rel="stylesheet" href="/static/css/cd_usuario/cd_cadastro_usuario_botoes.css">
  <link rel="stylesheet" href="/static/css/cd_usuario/cd_cadastro_usuario_componentes.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/static/css/formatacao_valores_campos/formatacao_telefone.css">
  <link rel="stylesheet" href="/static/css/formatacao_valores_campos/formatacao_email.css">
  <link rel="stylesheet" href="/static/css/formatacao_valores_campos/formatacao_email_institucional.css">
  <link rel="stylesheet" href="/static/css/formatacao_valores_campos/formatacao_ramal.css">
  <link rel="stylesheet" href="/static/css/formatacao_valores_campos/formatacao_tipo_usuario.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #eef5f9;
    }

    header.fad-header {
      text-align: center;
      background-color: #003366;
      padding: 10px;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    header.fad-header h1 {
      font-size: 40px;
      margin: 0;
      text-shadow: 1px 1px 2px #00000060;
    }

    header.fad-header h2 {
      font-size: 22px;
      margin-top: 4px;
      font-weight: bold;
      text-shadow: 1px 1px 2px #00000050;
    } 

    .form-container {
      max-width: 720px;
      margin: 30px auto;
      padding: 2rem;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .form-container > h3 {
      font-size: 22px;
      text-align: center;
      margin: 1rem 0;
    }

    .form-section {
      margin: 2rem 0;
      padding: 1rem 2.5%;
      border: 1px solid #cce0f5;
      border-radius: 8px;
      background-color: #f7fbff;
    }

    .form-section h3 {
      margin: 0 0 1rem 0;
      color: #003366;
      border-bottom: 1px solid #00336633;
      padding-bottom: .5rem;
      font-size: 18px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-row {
      display: flex;
      width: 100%;
      gap: 2.5%;
    }

    .form-field {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    input, select {
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .half       { width: 48.75%; }
    .full       { width: 100%; }    button:not(.btn-editar):not(.btn-atualizar-lista):not(.btn-confirmar-selecao):not(.btn-icone):not(.btn-pequeno):not(.confirmar-btn):not(.botao-fad) {
      display: block;
      width: 100%;
      padding: 0.9rem;
      background-color: #009933;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 2rem;
    }

    button:not(.btn-editar):not(.btn-atualizar-lista):not(.btn-confirmar-selecao):not(.btn-icone):not(.btn-pequeno):not(.confirmar-btn):not(.botao-fad):hover {
      background-color: #007a29;
    }

    .loading-msg {
      font-size: 13px;
      color: #555;
      font-style: italic;
      margin-top: 4px;
    }

    #sucessoBox {
      display: none;
      color: #0b6600;
      background: #e6ffe6;
      border: 1px solid #0b6600;
      padding: 12px;
      border-radius: 8px;
      margin-top: 18px;
      text-align: center;
      font-weight: bold;
    }

    #erroBox {
      display: none;
      color: #a80000;
      background: #ffeaea;
      border: 1px solid #a80000;
      padding: 12px;
      border-radius: 8px;
      margin-top: 18px;
      text-align: center;
      font-weight: bold;
    }

    /* Estilo bot√£o conforme Pessoa Jur√≠dica */
    .botao-fad {
      display: block;
      width: 100%;
      padding: 0.9rem;
      background-color: #009933;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 2rem;
      text-align: center;
      transition: background-color 0.3s;
    }

    .botao-fad:hover:not(:disabled) {
      background-color: #007a29;
    }

    .botao-fad:disabled {
      background-color: #b0b7c3;
      cursor: not-allowed;
    }

    /* Estilos espec√≠ficos para sele√ß√£o de PF */
    .hidden { display: none; }
    .resumo-box {
      background: #e8f4f8;
      border: 1px solid #b3d9e8;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 0.5rem;
    }    .btn-icone {
      background-color: transparent;
      color: #003366;
      border: 1px solid #003366;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 18px;
      transition: all 0.3s ease;
      margin: 0 2px;
      cursor: pointer;
      min-width: 32px;
      min-height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icone:hover {
      background-color: #e3f2fd;
      color: #001a33;
      border-color: #001a33;
    }

    .btn-pequeno {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      background-color: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-pequeno:hover {
      background-color: #555;
    }

    .btn-icone-fad {
      background: transparent;
      border: 1px solid #003366;
      color: #003366;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn-icone-fad:hover {
      background-color: #e3f2fd;
      color: #001a33;
      border-color: #001a33;
    }

    .confirmar-btn {
      background-color: #28a745;
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      margin-top: 0.5rem;
      cursor: pointer;
    }

    .confirmar-btn:hover {
      background-color: #218838;
    }

    /* Campo de resumo estilizado como campo comum */
    .campo-resumo {
      position: relative;
      width: 100%;
    }

    .campo-resumo input {
      width: 100%;
      padding: 0.7rem;
      padding-right: 45px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #f8f9fa;
      color: #495057;
      font-size: 1rem;
    }

    .campo-resumo .btn-editar {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background-color: transparent;
      color: #003366;
      border: 1px solid #003366;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .campo-resumo .btn-editar:hover {
      background-color: #e3f2fd;
      color: #001a33;
      border-color: #001a33;
    }

    /* Estilos para valida√ß√£o de senha */
    .senha-regras {
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
      margin-top: 8px;
      color: #666;
      font-size: 11px;
      white-space: nowrap;
      overflow-x: auto;
    }

    .senha-regras div {
      margin: 0;
      white-space: nowrap;
    }

    .regra-ok {
      color: #28a745 !important;
      font-weight: bold;
    }

    .senha-msg {
      font-size: 13px;
      margin-top: 5px;
    }

    .senha-erro {
      color: #dc3545;
    }

    .senha-sucesso {
      color: #28a745;
    }

    /* Estilos para indica√ß√£o de campos obrigat√≥rios */
    .required::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
    }

    .obrigatorio-icone {
      color: #dc3545;
      font-weight: bold;
      margin-left: 3px;
      font-size: 1.1em;
      transition: color 0.2s;
    }
    .check-icone {
      color: #145a32;
      font-weight: bold;
      margin-left: 3px;
      font-size: 1.1em;
      display: none;
      transition: color 0.2s;
    }
    .campo-validado .obrigatorio-icone {
      display: none;
    }
    .campo-validado .check-icone {
      display: inline;
    }

    /* Responsividade para dispositivos m√≥veis */
    @media (max-width: 768px) {
      .form-container {
        margin: 15px;
        padding: 1.5rem;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .half {
        width: 100%;
        margin-bottom: 1rem;
      }
      
      .form-section {
        padding: 1rem;
      }
    }

    .senha-input {
      width: 100%;
      font-size: 1rem;
      box-sizing: border-box;
    }
    #senha, #confirmar_senha {
      width: 100%;
      font-size: 1rem;
      box-sizing: border-box;
    }
    #tipo_usuario {
      width: 100%;
    }
    @media (max-width: 600px) {
      .senha-regras { flex-direction: column; gap: 2px; font-size: 10px; }
    }

    .erro-campo {
      border: 2px solid #dc3545 !important;
      background: #fff0f0 !important;
    }
  </style>
</head>
<body>  {% include 'componentes/fad_header.html' %}
  <div class="form-container">
    <h3>Cadastro de Usu√°rio</h3>
    <!-- üéØ FORMUL√ÅRIO DE INTERFACE - APENAS PARA UX (N√ÉO ENVIA DADOS) -->
    <!-- Este formul√°rio √© usado apenas para exibi√ß√£o, valida√ß√£o e experi√™ncia do usu√°rio -->
    <!-- Os dados s√£o copiados para o formul√°rio oculto quando o usu√°rio clica em "Gravar" -->
    <form method="post" action="#" id="usuarioForm" novalidate>      <!-- INFORMA√á√ïES PESSOAIS -->
      <div class="form-section">
        <h3>Informa√ß√µes Pessoais</h3>
        <div class="form-group">
          <div class="form-field full">
            <label for="opcaoPF">Nome Completo:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
            <select id="opcaoPF" required>
              <option value="">Selecione...</option>
              <option value="associar">Vincular PF j√° cadastrada</option>
              <option value="cadastrar">Cadastrar nova PF</option>
            </select>
          </div>
          <div id="boxPF" class="hidden">
            <div class="form-field full">
              <label for="pfSelect">Selecionar PF:</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <select id="pfSelect" style="width: 100%; padding-right: 45px;">
                  <option value="">Selecione uma PF</option>
                  <!-- Op√ß√µes ser√£o carregadas via JS -->
                </select>
                <button type="button" class="btn-icone" id="atualizarPFBtn" title="Atualizar lista" style="order:3;"><i class="fas fa-sync"></i></button>
                <button type="button" class="btn-icone editar-btn" title="Editar Sele√ß√£o" style="order:2;"><i class="fas fa-pen"></i></button>
                <button type="button" class="btn-icone" id="confirmarPFBtn" title="Confirmar Sele√ß√£o" style="order:1;"><i class="fas fa-check"></i></button>
              </div>
              <div id="pf-feedback" style="color: #a80000; font-size: 13px; margin-top: 2px;"></div>
            </div>
          </div>
          <div id="resumoPF" class="form-field full hidden">
            <div class="campo-resumo" style="display: flex; align-items: center; gap: 8px;">
              <input type="text" id="pfResumoTexto" readonly style="background-color: #f8f9fa; width: calc(100% - 45px);">
              <button type="button" class="btn-icone" id="editarPFBtn" title="Editar Sele√ß√£o"><i class="fas fa-pen"></i></button>
            </div>
            <input type="hidden" name="pessoa_fisica_id" id="pfInputFinal">
            <input type="hidden" name="nome" id="pfNomeFinal">
          </div>
          <div class="form-row">
            <div class="form-field half">
              <label for="cpf">CPF:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
              <input type="text" id="cpf" name="cpf" required maxlength="14" style="width: 100%; box-sizing: border-box;" />
              <div id="cpf-feedback" style="color: #a80000; font-size: 13px; margin-top: 2px;"></div>
            </div>
            <div class="form-field half">
              <label for="telefone">Telefone:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
              <input type="text" id="telefone" name="telefone" required maxlength="16" style="width: 100%; box-sizing: border-box;" />
              <div id="telefone-feedback" style="color: #a80000; font-size: 13px; margin-top: 2px;"></div>
            </div>          </div>          <div class="form-row">
            <div class="form-field half">
              <label for="email">E-mail:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
              <input type="email" id="email" name="email" required style="width: 100%; box-sizing: border-box;" />
              <div id="email-feedback" style="color: #a80000; font-size: 13px; margin-top: 2px;"></div>
            </div>
            <div class="form-field half">
              <label for="pessoa_fisica_id">ID Pessoa F√≠sica:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
              <input type="number" id="pessoa_fisica_id" name="pessoa_fisica_id" required style="width: 100%; box-sizing: border-box;" readonly />
              <div id="pessoa_fisica_id-feedback" style="color: #a80000; font-size: 13px; margin-top: 2px;"></div>
            </div>
          </div>
        </div>
        <div class="form-field full">
          <label for="tipo_usuario">
            Tipo de Usu√°rio:
            <span class="obrigatorio-icone">*</span>
            <span class="check-icone">&#10003;</span>
          </label>
          <select id="tipo_usuario" name="tipo" required style="width: 100%; box-sizing: border-box;">
            <option value="">Selecione o tipo de usu√°rio</option>
            <option value="analista">Analista</option>
            <option value="coordenador">Coordenador</option>
          </select>
          <div id="tipo-feedback" style="color: #a80000; font-size: 13px; margin-top: 2px;"></div>
        </div>
      </div>
      <!-- INFORMA√á√ïES PROFISSIONAIS -->
      <div class="form-section">
      <h3>Informa√ß√µes Profissionais</h3>
      <div class="form-group">
        <!-- 1. Institui√ß√£o -->
        <div class="form-field full" id="instituicao-container">
        <label for="instituicao">Institui√ß√£o:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="instituicao" name="instituicao" required>
          <option value="">Selecione...</option>
          <option value="DER/SP">DER/SP</option>
        </select>
        </div>
        <!-- 2. Tipo de Lota√ß√£o -->
        <div class="form-field full hidden" id="tipo-lotacao-container">
        <label for="tipo_lotacao">Tipo de Lota√ß√£o:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="tipo_lotacao" name="tipo_lotacao" required>
          <option value="">Selecione...</option>
          <option value="sede">Sede</option>
          <option value="regional">Regional</option>
        </select>
        </div>
        <!-- 3. Hierarquia Sede -->
        <div class="form-field full hidden" id="sede-hierarquia-container">
        <label for="sede_hierarquia">Hierarquia:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="sede_hierarquia" name="sede_hierarquia" required></select>
        </div>
        <!-- Assist√™ncia Direta (aparece ao selecionar √ìrg√£os de Assist√™ncia Direta) -->
        <div class="form-field full hidden" id="sede-assistencia-direta-container">
        <label for="sede_assistencia_direta">Assist√™ncia Direta:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="sede_assistencia_direta" name="sede_assistencia_direta" required></select>
        </div>
        <!-- Diretoria (aparece ao selecionar Diretorias em Hierarquia) -->
        <div class="form-field full hidden" id="sede-diretoria-container">
        <label for="sede_diretoria">Diretoria:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="sede_diretoria" name="sede_diretoria" required></select>
        </div>
        <!-- Coordenadoria Geral (aparece ao selecionar Diretoria) -->
        <div class="form-field full hidden" id="sede-coordenadoria-geral-container">
        <label for="sede_coordenadoria_geral">Coordenadoria Geral:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="sede_coordenadoria_geral" name="sede_coordenadoria_geral" required></select>
        </div>
        <!-- Coordenadoria (aparece ao selecionar Coordenadoria Geral) -->
        <div class="form-field full hidden" id="sede-coordenadoria-container">
        <label for="sede_coordenadoria">Coordenadoria:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
        <select id="sede_coordenadoria" name="sede_coordenadoria" required></select>
        </div>
        <!-- 4. Assist√™ncia (aparece ao selecionar Setor) -->
        <div class="form-field full hidden" id="sede-assistencia-container">
          <label for="sede_assistencia">Assist√™ncia:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
          <select id="sede_assistencia" name="sede_assistencia" required></select>
        </div>
        <!-- Tipo regional selecionado -->
        <div class="form-field full hidden" id="regional-nome-container">
          <label for="regional_nome">Coordenadoria Regional:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
          <select id="regional_nome" name="regional_nome" required></select>
        </div>
        <div class="form-field full hidden" id="regional-coordenadoria-container">
          <label for="regional_coordenadoria">Coordenadoria:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
          <select id="regional_coordenadoria" name="regional_coordenadoria" required></select>
        </div>        <div class="form-field full hidden" id="regional-setor-container">
          <label for="regional_setor">Setor Servi√ßo Regional:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
          <select id="regional_setor" name="regional_setor" required></select>
        </div>
        <!-- Adicionar campos institucionais na se√ß√£o profissional -->
        <div class="form-row">
          <div class="form-field full">
            <label for="email_institucional">E-mail Institucional:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
            <input type="email" id="email_institucional" name="email_institucional" required placeholder="exemplo@fad.gov.br" style="width: 100%; box-sizing: border-box;" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="telefone_institucional">Telefone Institucional:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
            <input type="text" id="telefone_institucional" name="telefone_institucional" required maxlength="16" placeholder="(21) 99999-9999" style="width: 100%; box-sizing: border-box;" />
          </div>
          <div class="form-field">
            <label for="ramal">Ramal:<span class="obrigatorio-icone">*</span><span class="check-icone">&#10003;</span></label>
            <input type="text" id="ramal" name="ramal" required maxlength="10" placeholder="1234" style="width: 100%; box-sizing: border-box;" />
          </div>
        </div>
      </div>
    </div><!-- INFORMA√á√ïES DE ACESSO AO SISTEMA -->
  <div class="form-section">
    <h3>Informa√ß√µes de Acesso ao Sistema</h3>
    <div class="form-group">
      <div class="form-field full">
        <label for="senha" class="required">Senha:</label>
        <div style="position: relative;">
          <input type="password" id="senha" name="senha" required class="senha-input" style="padding-right: 40px;" />
          <span onclick="toggleSenha('senha')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">üëÅÔ∏è</span>
        </div>
        <div id="regrasSenha" class="senha-regras">
          <div id="regra1">‚Ä¢ No m√≠nimo 5 caracteres</div>
          <div id="regra2">‚Ä¢ Letras mai√∫sculas</div>
          <div id="regra3">‚Ä¢ Letras min√∫sculas</div>
          <div id="regra4">‚Ä¢ N√∫meros</div>
          <div id="regra5">‚Ä¢ Caracteres especiais</div>
        </div>
      </div>
      
      <div class="form-field full">
        <label for="confirmar_senha" class="required">Confirmar Senha:</label>
        <div style="position: relative;">
          <input type="password" id="confirmar_senha" name="confirmar_senha" required class="senha-input" style="padding-right: 40px;" />
          <span onclick="toggleSenha('confirmar_senha')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">üëÅÔ∏è</span>
        </div>
        <div id="mensagemSenha" class="senha-msg"></div>
      </div>
    </div>
  </div>
  <!-- Bot√£o Gravar: copia valores para o form de envio -->
  <button type="button" class="botao-fad" id="btnGravar">Gravar</button>
  <!-- Bot√£o Cadastrar: envia ao back-end ap√≥s gravar -->
  <button type="button" class="botao-fad" id="btnCadastrar" disabled>Cadastrar</button>

  <!-- Barra de progresso -->
  <div id="progressBarContainer" style="display: none; margin-top: 20px;">
    <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
      <div id="progressBarFill" style="background: #4caf50; height: 20px; width: 0%; transition: width 0.3s;"></div>
    </div>
    <div style="text-align: center; margin-top: 5px;">
      <span id="progressBarPercent">0%</span> - <span id="progressBarStatus">Preparando...</span>
    </div>
  </div>

  <!-- Console de mensagens em tempo real -->
  <div id="realTimeConsole" style="display: none; margin-top: 15px; max-height: 300px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
    <div style="font-weight: bold; color: #495057; margin-bottom: 10px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">üìã Log do Processo:</div>
    <div id="consoleMessages" style="font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;"></div>
  </div>  <!-- Script de a√ß√µes dos bot√µes Gravar e Cadastrar -->
  <script>
    // ============================================================================
    // FLUXO DO SISTEMA DE CADASTRO:
    // 1. INTERFACE ‚Üí Apenas UX (exibi√ß√£o, valida√ß√£o, dropdowns hier√°rquicos)
    // 2. GRAVAR ‚Üí Copia dados da interface para formul√°rio separado via iframe
    // 3. CADASTRAR ‚Üí Envia formul√°rio separado via AJAX para PostgreSQL
    // ============================================================================
    
    // üîÑ ETAPA 1: Copia dados da INTERFACE para FORMUL√ÅRIO SEPARADO
    document.getElementById('btnGravar').addEventListener('click', function() {
      console.log('üîÑ GRAVAR: Carregando formul√°rio separado e copiando dados...');
      addRealTimeMessage('üîÑ GRAVAR: Carregando formul√°rio separado e copiando dados...');
      
      const campos = [
        'nome','cpf','telefone','email','email_institucional','telefone_institucional','ramal','pessoa_fisica_id',
        'instituicao','tipo_lotacao','sede_hierarquia','sede_assistencia_direta','sede_diretoria',
        'sede_coordenadoria_geral','sede_coordenadoria','sede_assistencia',
        'regional_nome','regional_coordenadoria','regional_setor','tipo','senha'
      ];
      
      // Cria iframe oculto para carregar o formul√°rio de envio separado
      let iframe = document.getElementById('envioIframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'envioIframe';
        iframe.src = '/cadastro-usuario-sistema-envio';
        iframe.style.display = 'none';
        iframe.style.width = '0';
        iframe.style.height = '0';
        document.body.appendChild(iframe);
        console.log('üì§ Iframe criado e carregando formul√°rio separado...');
        addRealTimeMessage('üì§ Iframe criado e carregando formul√°rio separado...');
      }
      
      // Aguarda o iframe carregar completamente
      iframe.onload = function() {
        try {
          console.log('‚úÖ Formul√°rio separado carregado. Copiando dados...');
          addRealTimeMessage('‚úÖ Formul√°rio separado carregado. Copiando dados...');
          const envioDoc = iframe.contentDocument || iframe.contentWindow.document;
          let copiados = 0;
            campos.forEach(id => {
            let srcId = id; // Por padr√£o, o ID na interface √© igual ao ID no envio
            
            // Mapeamentos especiais para campos com IDs diferentes na interface
            if (id === 'tipo') srcId = 'tipo_usuario';
            if (id === 'nome') srcId = 'pfNomeFinal';
            if (id === 'pessoa_fisica_id') srcId = 'pfInputFinal';
            
            const src = document.getElementById(srcId);
            const dest = envioDoc.getElementById(id);
            
            if (src && dest) {
              dest.value = src.value;
              if (src.value) copiados++;
            } else if (!dest) {
              console.warn(`‚ö†Ô∏è Campo ${id} n√£o encontrado no formul√°rio de envio`);
              addRealTimeMessage(`‚ö†Ô∏è Campo ${id} n√£o encontrado no formul√°rio de envio`, 'warning');
            }
          });
          
          console.log(`‚úÖ ${copiados} campos copiados para formul√°rio separado`);
          addRealTimeMessage(`‚úÖ ${copiados} campos copiados para formul√°rio separado`);
          
          // Armazena refer√™ncia do iframe para uso posterior
          window.envioIframe = iframe;
          
          // Habilita bot√£o Cadastrar
          document.getElementById('btnCadastrar').disabled = false;
          console.log('‚úÖ Bot√£o CADASTRAR habilitado');
          addRealTimeMessage('‚úÖ Bot√£o CADASTRAR habilitado');
          
        } catch (error) {
          console.error('‚ùå Erro ao copiar dados para formul√°rio separado:', error);
          addRealTimeMessage('‚ùå Erro ao copiar dados para formul√°rio separado: ' + error.message, 'error');
          alert('Erro ao preparar formul√°rio de envio. Verifique se o formul√°rio separado est√° acess√≠vel.');
        }
      };
      
      // For√ßa reload se j√° existe
      if (iframe.src) {
        iframe.src = iframe.src;
      }
    });

    // Fun√ß√£o para adicionar mensagens em tempo real na interface
function addRealTimeMessage(message, type = 'info') {
  const realTimeConsole = document.getElementById('realTimeConsole');
  const consoleMessages = document.getElementById('consoleMessages');
  
  // Mostra o console se ainda n√£o estiver vis√≠vel
  if (realTimeConsole.style.display === 'none') {
    realTimeConsole.style.display = 'block';
  }
  
  // Define cores baseadas no tipo
  let color = '#495057'; // default
  if (type === 'error') color = '#dc3545';
  else if (type === 'warning') color = '#ffc107';
  else if (type === 'success') color = '#28a745';
  
  // Cria nova linha de mensagem
  const messageDiv = document.createElement('div');
  messageDiv.style.color = color;
  messageDiv.style.marginBottom = '3px';
  messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  
  // Adiciona mensagem e scrolla para baixo
  consoleMessages.appendChild(messageDiv);
  realTimeConsole.scrollTop = realTimeConsole.scrollHeight;
}

// üì§ ETAPA 2: Envia dados do FORMUL√ÅRIO SEPARADO via AJAX para PostgreSQL
document.getElementById('btnCadastrar').addEventListener('click', async function(e) {
  e.preventDefault();
  console.log('üì§ CADASTRAR: Enviando formul√°rio separado para PostgreSQL...');
  addRealTimeMessage('üì§ CADASTRAR: Enviando formul√°rio separado para PostgreSQL...');
  
  const btn = this;
  btn.disabled = true;
  
  // Verifica se o iframe existe
  const iframe = window.envioIframe || document.getElementById('envioIframe');
  if (!iframe) {
    alert('Erro: Formul√°rio de envio n√£o foi preparado. Clique em "Gravar" primeiro.');
    btn.disabled = false;
    return;
  }
  
  // Exibe barra de progresso
  document.getElementById('progressBarContainer').style.display = 'block';
  document.getElementById('progressBarFill').style.width = '10%';
  document.getElementById('progressBarPercent').textContent = '10%';
  document.getElementById('progressBarStatus').textContent = 'Preparando envio...';

  // Exibe console de mensagens
  const consoleDiv = document.getElementById('realTimeConsole');
  const messagesDiv = document.getElementById('consoleMessages');
  consoleDiv.style.display = 'block';
  messagesDiv.innerHTML = ''; // Limpa mensagens anteriores
  
  try {
    // üìã Coleta dados do formul√°rio separado via iframe
    console.log('üìã Coletando dados do formul√°rio separado...');
    const envioDoc = iframe.contentDocument || iframe.contentWindow.document;
    const envioForm = envioDoc.getElementById('envioForm');
    
    if (!envioForm) {
      throw new Error('Formul√°rio de envio n√£o encontrado no iframe');
    }
      const fd = new FormData(envioForm);
    const dados = {};
    fd.forEach((v, k) => { dados[k] = v; });
    
    // N√ÉO remove campos vazios - deixa o backend decidir
    // Object.keys(dados).forEach(key => { if (dados[key] === '') delete dados[key]; });
    
    console.log('üìä Dados que ser√£o enviados ao PostgreSQL:', dados);
    console.log(`üìà Total de campos: ${Object.keys(dados).length}`);

    document.getElementById('progressBarFill').style.width = '50%';
    document.getElementById('progressBarPercent').textContent = '50%';
    document.getElementById('progressBarStatus').textContent = 'Enviando ao servidor...';        const resp = await fetch('/api/cd/cadastro-usuario-sistema', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });
    
    if (!resp.ok) {
      const errorData = await resp.text();
      console.error('‚ùå Erro do servidor:', errorData);
      throw new Error(`Status ${resp.status}: ${errorData}`);
    }

    document.getElementById('progressBarFill').style.width = '80%';
    document.getElementById('progressBarPercent').textContent = '80%';
    document.getElementById('progressBarStatus').textContent = 'Processando resposta...';
    await resp.json();

    document.getElementById('progressBarFill').style.width = '100%';
    document.getElementById('progressBarPercent').textContent = '100%';
    document.getElementById('progressBarStatus').textContent = 'Cadastro conclu√≠do!';
    document.getElementById('sucessoBox').style.display = 'block';
    
    // Mensagem de sucesso no console
    const sucessoMsg = document.createElement('div');
    sucessoMsg.style.color = '#28a745';
    sucessoMsg.style.fontWeight = 'bold';
    sucessoMsg.innerHTML = '‚úÖ Cadastro realizado com sucesso!';
    messagesDiv.appendChild(sucessoMsg);
    
    // Reset formul√°rio de interface
    document.getElementById('usuarioForm').reset();
    
    // Remove iframe ap√≥s sucesso
    if (iframe && iframe.parentNode) {
      iframe.parentNode.removeChild(iframe);
      window.envioIframe = null;
    }
    
    btn.disabled = true;
    
  } catch (err) {
    document.getElementById('erroBox').style.display = 'block';
    document.getElementById('erroBox').textContent = 'Erro: ' + err.message;
    console.error('‚ùå Erro no cadastro:', err);
    
    // Mensagem de erro no console
    const erroMsg = document.createElement('div');
    erroMsg.style.color = '#dc3545';
    erroMsg.style.fontWeight = 'bold';
    erroMsg.innerHTML = '‚ùå Erro: ' + err.message;
    messagesDiv.appendChild(erroMsg);
    
    btn.disabled = false;
  }
});
  </script>
  </form>

<div style="text-align:center; margin-top: 30px;">
  <a href="/boas-vindas" class="menu-link" style="background:#004080; color:#fff; text-decoration:none; padding:10px 22px; border-radius:6px; font-size:16px; font-weight:500; display:inline-block;">P√°gina inicial</a>
</div>

<div id="sucessoBox">Cadastro realizado com sucesso!</div>
<div id="erroBox"></div>
<div id="okBtnContainer" style="display:none; text-align:center; margin-top:16px;">
  <button id="okBtn" style="padding:10px 32px; font-size:1.1rem; background:#003366; color:#fff; border:none; border-radius:6px; cursor:pointer;">OK</button>
</div>
</div>  <script type="module" src="/static/js/formatacao_valores_campos/formatacao_cpf.js"></script>
<script type="module" src="/static/js/formatacao_valores_campos/formatacao_telefone_movel.js"></script>
<script type="module" src="/static/js/formatacao_valores_campos/formatacao_email.js"></script>
<script type="module" src="/static/js/formatacao_valores_campos/formatacao_email_institucional.js"></script>
<script type="module" src="/static/js/formatacao_valores_campos/formatacao_ramal.js"></script>
<script type="module" src="/static/js/formatacao_valores_campos/formatacao_pessoa_fisica_id.js"></script>
<script src="/static/js/cd_usuario/formulario_usuario_unificado.js"></script>
<script src="/static/js/cd_usuario/logicas_listas_infos_pessoais.js"></script>
<script src="/static/js/cd_usuario/logicas_listas_infos_profissionais.js"></script>
<script>
        // Carregar lista de PFs automaticamente ao selecionar "associar"
        document.getElementById('opcaoPF').addEventListener('change', function() {
          if (this.value === 'associar') {
            document.getElementById('boxPF').classList.remove('hidden');
            fetch('/cadastro/pfs/json').then(r => r.json()).then(pfs => {
              const pfSelect = document.getElementById('pfSelect');
              pfSelect.innerHTML = '<option value="">Selecione uma PF</option>';
              pfs.forEach(pf => {
                pfSelect.innerHTML += `<option value="${pf.id}" data-cpf="${pf.cpf}" data-email="${pf.email}" data-telefone="${pf.telefone}" data-nome="${pf.nome}">${pf.nome} (${pf.cpf})</option>`;
              });
            });
          } else {
            document.getElementById('boxPF').classList.add('hidden');
          }
        });
        
        // Utilit√°rio para esconder todos os checkpoints e ret√¢ngulos verdes de valida√ß√£o
        function limparValidacaoVisualCampos(campos) {
          campos.forEach(function(id) {
            const input = document.getElementById(id);
            if (!input) return;
            input.classList.remove('erro-campo');
            const field = input.closest('.form-field');
            if (field) field.classList.remove('campo-validado');
            // Esconde o check-icone e mostra o asterisco
            const label = field ? field.querySelector('label') : null;
            if (label) {
              const check = label.querySelector('.check-icone');
              const asterisco = label.querySelector('.obrigatorio-icone');
              if (check) check.style.display = 'none';
              if (asterisco) asterisco.style.display = 'inline';
            }
          });
        }
          // Sele√ß√£o de PF preenche campos
        document.getElementById('pfSelect').addEventListener('change', function() {
          const opt = this.options[this.selectedIndex];
          const cpf = document.getElementById('cpf');
          const email = document.getElementById('email');
          const tel = document.getElementById('telefone');
          const pfId = document.getElementById('pessoa_fisica_id');
          cpf.value = opt.getAttribute('data-cpf') || '';
          email.value = opt.getAttribute('data-email') || '';
          tel.value = opt.getAttribute('data-telefone') || '';
          pfId.value = opt.value || '';
          document.getElementById('pfResumoTexto').value = opt.getAttribute('data-nome') || '';
          document.getElementById('pfInputFinal').value = opt.value;
          document.getElementById('pfNomeFinal').value = opt.getAttribute('data-nome') || '';
          document.getElementById('resumoPF').classList.remove('hidden');
          // Dispara input para CPF, telefone, e-mail e ID PF aqui!
          cpf.dispatchEvent(new Event('input', { bubbles: true }));
          tel.dispatchEvent(new Event('input', { bubbles: true }));
          email.dispatchEvent(new Event('input', { bubbles: true }));
          pfId.dispatchEvent(new Event('input', { bubbles: true }));
          // Garante valida√ß√£o visual e habilita√ß√£o do bot√£o Gravar
          if (typeof window.checarTodosCamposValidos === 'function') {
            window.checarTodosCamposValidos();
          }
        });
        
        // Bot√£o confirmar: bloqueia sele√ß√£o, mostra resumo e bot√£o editar
        document.getElementById('confirmarPFBtn').addEventListener('click', function() {
          document.getElementById('boxPF').classList.add('hidden');
          document.getElementById('resumoPF').classList.remove('hidden');
          document.getElementById('editarPFBtn').style.display = 'inline-block';
          // Dispara o evento input para garantir m√°scara/valida√ß√£o S√ì aqui
          const cpf = document.getElementById('cpf');
          const tel = document.getElementById('telefone');
          const email = document.getElementById('email');
          cpf.dispatchEvent(new Event('input', { bubbles: true }));
          tel.dispatchEvent(new Event('input', { bubbles: true }));
          email.dispatchEvent(new Event('input', { bubbles: true }));
        });
          // Bot√£o editar: retorna ao estado inicial da sele√ß√£o de PF e limpa toda valida√ß√£o visual
        document.getElementById('editarPFBtn').addEventListener('click', function() {
          document.getElementById('resumoPF').classList.add('hidden');
          document.getElementById('boxPF').classList.remove('hidden');
          document.getElementById('opcaoPF').value = 'associar';
          document.getElementById('pfSelect').selectedIndex = 0;
          document.getElementById('cpf').value = '';
          document.getElementById('email').value = '';
          document.getElementById('telefone').value = '';
          document.getElementById('pessoa_fisica_id').value = '';
          document.getElementById('pfResumoTexto').value = '';
          document.getElementById('pfInputFinal').value = '';
          document.getElementById('pfNomeFinal').value = '';
          document.getElementById('cpf-feedback').innerText = '';
          document.getElementById('telefone-feedback').innerText = '';
          document.getElementById('email-feedback').innerText = '';
          // Remove valida√ß√£o visual dos campos e checkpoints/ret√¢ngulos verdes
          limparValidacaoVisualCampos(['cpf','telefone','email','opcaoPF','pessoa_fisica_id']);
        });
      </script>
      <script>
// Garante que o bot√£o Gravar fique sempre habilitado
window.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('btnGravar');
  if (btn) btn.disabled = false;
});
</script>
<script>
function mostrarOkBtn() {
  document.getElementById('okBtnContainer').style.display = 'block';
  document.getElementById('okBtn').onclick = function() {
    document.getElementById('okBtnContainer').style.display = 'none';
    location.reload();
  };
}
// Exibe bot√£o OK ap√≥s sucesso ou erro
function exibirMensagemSucesso() {
  document.getElementById('sucessoBox').style.display = 'block';
  mostrarOkBtn();
}
function exibirMensagemErro(msg) {
  document.getElementById('erroBox').style.display = 'block';
  document.getElementById('erroBox').textContent = msg;
  mostrarOkBtn();
}
// Substitua as chamadas de exibi√ß√£o de mensagem por exibirMensagemSucesso() e exibirMensagemErro(msg)
</script>
</body>
</html>



