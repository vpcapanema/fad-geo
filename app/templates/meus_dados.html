<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Minhas Informações - FAD</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    @font-face {
      font-family: 'Amazone BT';
      src: url('/static/fonts/amazone-bt.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
    }
    .fad-header {
      background-color: #004080;
      padding: 10px 0;
      text-align: center;
    }
    .fad-header .logo-fad {
      height: 180px;
      max-height: 220px;
      margin: 0 auto;
      display: block;
      cursor: pointer;
    }
    .logout button {
      background-color: #004080;
      color: #fff;
      border: 2px solid #fff;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: background 0.2s, color 0.2s;
    }
    .logout button:hover {
      background-color: #0056b3;
      color: #fff;
      border-color: #fff;
    }
    .painel-container {
      display: block;
      width: 100%;
      max-width: 600px;
      margin: 40px auto 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 {
      color: #003366;
      text-align: center;
      font-size: 22px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 18px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 10px;
    }
    label {
      font-weight: bold;
      color: #003366;
      margin-bottom: 4px;
    }
    input, select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      background: #f8fafc;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .container-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
      justify-content: center;
      margin-top: 40px;
    }
    .container-informacoes {
      flex: 1 1 350px;
      min-width: 320px;
      max-width: 600px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.07);
      padding: 2rem 2rem 1.5rem 2rem;
      margin-bottom: 30px;
    }
    .container-informacoes h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .btn-salvar {
      background-color: #004080;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 0;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 18px;
      transition: background 0.2s;
    }
    .btn-salvar:hover {
      background-color: #0056b3;
    }
    .btn-icone {
      background: none;
      border: none;
      color: #004080;
      cursor: pointer;
      font-size: 18px;
      margin: 0 5px;
      transition: color 0.2s;
    }    .btn-icone:hover {
      color: #0056b3;
    }
    /* Estilos para o bloco de status de sessão */
    #session-status {
      background: #e3f2fd;
      color: #003366;
      padding: 10px 0;
      text-align: center;
      font-size: 17px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }
    /* Estilos para containers dinâmicos dos dados profissionais */
    .hidden {
      display: none !important;
    }
    #tipo-lotacao-container,
    #sede-hierarquia-container,
    #sede-coordenadoria-container,
    #sede-setor-container,
    #sede-assistencia-container,
    #regional-nome-container,
    #regional-coordenadoria-container,
    #regional-setor-container,
    #sede-diretoria-container,
    #sede-coordenadoria-geral-container {
      margin-bottom: 15px;
    }
    #tipo-lotacao-container label,
    #sede-hierarquia-container label,
    #sede-coordenadoria-container label,
    #sede-setor-container label,
    #sede-assistencia-container label,
    #regional-nome-container label,
    #regional-coordenadoria-container label,
    #regional-setor-container label,
    #sede-diretoria-container label,
    #sede-coordenadoria-geral-container label {
      font-weight: bold;
      color: #003366;
      margin-bottom: 4px;
      display: block;
    }
    #tipo-lotacao-container select,
    #sede-hierarquia-container select,
    #sede-coordenadoria-container select,
    #sede-setor-container select,
    #sede-assistencia-container select,
    #regional-nome-container select,
    #regional-coordenadoria-container select,
    #regional-setor-container select,
    #sede-diretoria-container select,
    #sede-coordenadoria-geral-container select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      background: #f8fafc;
    }
    .form-section {
      margin-top: 30px;
      padding: 1.5rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-section h3 {
      font-size: 18px;
      color: #003366;
      margin-bottom: 15px;
      text-align: center;
    }
    .btn-pequeno {
      background-color: #004080;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-pequeno:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
<header class="fad-header">
  <div class="logout" style="position:absolute;top:10px;right:20px;z-index:10;">
    <form action="/login/logout" method="post">
      <button type="submit">Sair</button>
    </form>
  </div>
  <div style="text-align:center;">
    <img src="/static/images/fad_logo_banco_completo1.png"
         alt="FAD - Ferramenta de Análise Dinamizada"
         class="logo-fad"
         style="margin: 0 auto; display: block; cursor:pointer;"
         onclick="window.location.href='/'">
  </div>
</header>
<!-- Bloco de status de sessão logo após o cabeçalho -->
<div id="session-status">
  Usuário logado: {{ usuario.nome }} |
  Tempo restante da sessão: <span id="session-timer"></span>
</div>
<div class="container-flex">
  <div class="container-informacoes" id="container-informacoes-pessoais">
    <h2>Informações Pessoais</h2>
    <form id="form-informacoes-pessoais" data-pf-id="{{ usuario_pf.id }}">
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" value="{{ usuario_pf.nome }}" readonly />
      </div>
      <div class="form-group">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" value="{{ usuario_pf.cpf }}" readonly />
      </div>
      <div class="form-group">
        <label for="email">E-mail</label>
        <input type="email" id="email" name="email" value="{{ usuario_pf.email }}" readonly />
      </div>
      <div class="form-group">
        <label for="telefone">Telefone</label>
        <input type="text" id="telefone" name="telefone" value="{{ usuario_pf.telefone }}" readonly />
      </div>
      <div class="form-group">
        <label for="rua">Rua</label>
        <input type="text" id="rua" name="rua" value="{{ usuario_pf.rua }}" readonly />
      </div>
      <div class="form-group">
        <label for="numero">Número</label>
        <input type="text" id="numero" name="numero" value="{{ usuario_pf.numero }}" readonly />
      </div>
      <div class="form-group">
        <label for="complemento">Complemento</label>
        <input type="text" id="complemento" name="complemento" value="{{ usuario_pf.complemento }}" readonly />
      </div>
      <div class="form-group">
        <label for="bairro">Bairro</label>
        <input type="text" id="bairro" name="bairro" value="{{ usuario_pf.bairro }}" readonly />
      </div>
      <div class="form-group">
        <label for="cep">CEP</label>
        <input type="text" id="cep" name="cep" value="{{ usuario_pf.cep }}" readonly />
      </div>
      <div class="form-group">
        <label for="cidade">Cidade</label>
        <input type="text" id="cidade" name="cidade" value="{{ usuario_pf.cidade }}" readonly />
      </div>
      <div class="form-group">
        <label for="uf">UF</label>
        <input type="text" id="uf" name="uf" value="{{ usuario_pf.uf }}" readonly />
      </div>
    </form>
    <div id="feedback-pf" style="text-align:center; margin-top:10px; display:none;"></div>
    <div style="text-align:center; margin-top:18px;">
      <button class="btn-icone" title="Editar" onclick="habilitarEdicao('form-informacoes-pessoais', this)"><i class="fa-solid fa-pen-to-square"></i></button>
      <button class="btn-icone" title="Salvar" onclick="salvarInformacoes('form-informacoes-pessoais', this)"><i class="fa-solid fa-floppy-disk"></i></button>
      <button class="btn-icone" title="Cancelar" onclick="cancelarEdicao('form-informacoes-pessoais', this)"><i class="fa-solid fa-ban"></i></button>
    </div>
  </div>
  <div class="container-informacoes" id="container-informacoes-profissionais">
    <h2>Informações Profissionais</h2>
    <div id="feedback-profissionais" style="text-align:center; margin-bottom:10px; display:none;"></div>
    <div id="dadosProfissionaisView">
      <label for="instituicao" class="required">Instituição:</label>
      <input type="text" id="instituicao-view" value="{{ usuario.instituicao if usuario else '' }}" readonly />
      <label for="tipo_lotacao">Tipo de Lotação:</label>
      <input type="text" id="tipo_lotacao-view" value="{{ usuario.tipo_lotacao if usuario else '' }}" readonly />
      <label for="sede_hierarquia">Órgão/Setor:</label>
      <input type="text" id="sede_hierarquia-view" value="{{ usuario.sede_hierarquia if usuario else '' }}" readonly />
      <label for="regional_nome">Regional:</label>
      <input type="text" id="regional_nome-view" value="{{ usuario.regional_nome if usuario else '' }}" readonly />
      <label for="email_institucional">E-mail institucional:</label>
      <input type="text" id="email_institucional-view" value="{{ usuario.email_institucional if usuario else '' }}" readonly />
      <label for="telefone_institucional">Telefone institucional:</label>
      <input type="text" id="telefone_institucional-view" value="{{ usuario.telefone_institucional if usuario else '' }}" readonly />
      <label for="ramal">Ramal:</label>
      <input type="text" id="ramal-view" value="{{ usuario.ramal if usuario else '' }}" readonly />
      <div style="text-align:center; margin-top:10px;">
        <button type="button" class="btn-pequeno" onclick="habilitarEdicaoProfissionais()">Editar</button>
      </div>
    </div>    <form id="formProfissionais" class="hidden">
      <!-- 1. Instituição -->
      <div id="instituicao-container">
        <label for="instituicao" class="required">Instituição:</label>
        <select id="instituicao" name="instituicao" required>
          <option value="">Selecione...</option>
          <option value="DER/SP">DER/SP</option>
        </select>
      </div>
      
      <!-- 2. Tipo de Lotação -->
      <div id="tipo-lotacao-container" class="hidden">
        <label for="tipo_lotacao">Tipo de Lotação:</label>
        <select id="tipo_lotacao" name="tipo_lotacao">
          <option value="">Selecione...</option>
          <option value="sede">Sede</option>
          <option value="regional">Regional</option>
        </select>
      </div>
      
      <!-- 3. Hierarquia Sede -->
      <div id="sede-hierarquia-container" class="hidden">
        <label for="sede_hierarquia">Hierarquia:</label>
        <select id="sede_hierarquia" name="sede_hierarquia"></select>
      </div>
      <div id="sede-coordenadoria-container" class="hidden">
        <label for="sede_coordenadoria">Coordenadoria:</label>
        <select id="sede_coordenadoria" name="sede_coordenadoria"></select>
      </div>
      <div id="sede-setor-container" class="hidden">
        <label for="sede_setor">Setor:</label>
        <select id="sede_setor" name="sede_setor"></select>
      </div>
      <div id="sede-assistencia-container" class="hidden">
        <label for="sede_assistencia">Assistência:</label>
        <select id="sede_assistencia" name="sede_assistencia"></select>
      </div>
      
      <!-- 4. Hierarquia Regional -->
      <div id="regional-nome-container" class="hidden">
        <label for="regional_nome">Nome da Regional:</label>
        <select id="regional_nome" name="regional_nome"></select>
      </div>
      <div id="regional-coordenadoria-container" class="hidden">
        <label for="regional_coordenadoria">Coordenadoria Regional:</label>
        <select id="regional_coordenadoria" name="regional_coordenadoria"></select>
      </div>
      <div id="regional-setor-container" class="hidden">
        <label for="regional_setor">Setor Regional:</label>
        <select id="regional_setor" name="regional_setor"></select>
      </div>
      
      <!-- 5. E-mail, Telefone, Ramal -->
      <label for="email_institucional">E-mail institucional:</label>
      <input type="email" id="email_institucional" name="email_institucional" required />
      <label for="telefone_institucional">Telefone institucional:</label>
      <input type="text" id="telefone_institucional" name="telefone_institucional" maxlength="16" required />
      <label for="ramal">Ramal:</label>
      <input type="text" id="ramal" name="ramal" maxlength="10" />
      
      <div style="text-align:center; margin-top:10px;">
        <button type="button" class="btn-pequeno" onclick="salvarProfissionais()">Salvar</button>
        <button type="button" class="btn-pequeno" onclick="cancelarEdicaoProfissionais()">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<script>
// Por padrão, todos os campos permanecem readonly
let valoresOriginaisPF = {};
let valoresOriginaisProf = {};

// Desabilita botões Salvar/Cancelar inicialmente
window.onload = function() {
  document.querySelectorAll('.container-informacoes').forEach(function(container) {
    const botoes = container.querySelectorAll('.btn-icone[title="Salvar"], .btn-icone[title="Cancelar"]');
    botoes.forEach(btn => btn.disabled = true);
  });
};

function habilitarEdicao(formId, btn) {
  const form = document.getElementById(formId);
  if (!form) return;
  // Salva valores originais
  if(formId === 'form-informacoes-pessoais') {
    valoresOriginaisPF = {};
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
        valoresOriginaisPF[el.name] = el.value;
        el.removeAttribute('readonly');
      }
    });
  } else {
    valoresOriginaisProf = {};
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
        valoresOriginaisProf[el.name] = el.value;
      }
      // Alterna entre input e select
      if (el.tagName === 'INPUT' && el.nextElementSibling && el.nextElementSibling.tagName === 'SELECT') {
        el.style.display = 'none';
        el.nextElementSibling.style.display = '';
        el.nextElementSibling.value = el.value;
      }
      if (el.tagName === 'SELECT') {
        el.removeAttribute('readonly');
      }
    });
  }
  // Habilita botões Salvar/Cancelar
  const container = form.closest('.container-informacoes');
  if (container) {
    const botoes = container.querySelectorAll('.btn-icone[title="Salvar"], .btn-icone[title="Cancelar"]');
    botoes.forEach(btn => btn.disabled = false);
  }
  document.getElementById('feedback-pf').style.display = 'none';
}

async function salvarInformacoes(formId, btn) {
  const form = document.getElementById(formId);
  if (!form) return;
  // Desabilita botões após salvar
  const container = form.closest('.container-informacoes');
  if (container) {
    const botoes = container.querySelectorAll('.btn-icone[title="Salvar"], .btn-icone[title="Cancelar"]');
    botoes.forEach(btn => btn.disabled = true);
  }
  if(formId === 'form-informacoes-pessoais') {
    const pfId = form.getAttribute('data-pf-id');
    if (!pfId) {
      mostrarFeedbackPF('ID da pessoa física não encontrado.', false);
      return;
    }
    const dados = {};
    Array.from(form.elements).forEach(el => {
      if (el.name) dados[el.name] = el.value;
    });
    try {
      const resp = await fetch(`/cadastro/pessoa-fisica/${pfId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
      if (resp.ok) {
        mostrarFeedbackPF('Informações pessoais salvas com sucesso!', true);
        // Volta para readonly
        Array.from(form.elements).forEach(el => {
          if (el.tagName === 'INPUT' || el.tagName === 'SELECT') el.setAttribute('readonly', true);
        });
      } else {
        const data = await resp.json();
        mostrarFeedbackPF(data.detail || 'Erro ao salvar informações.', false);
      }
    } catch (e) {
      mostrarFeedbackPF('Erro de conexão ao salvar informações.', false);
    }
  } else {
    // Profissionais: alterna selects para inputs
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'SELECT' && el.previousElementSibling && el.previousElementSibling.tagName === 'INPUT') {
        el.previousElementSibling.value = el.value;
        el.previousElementSibling.style.display = '';
        el.style.display = 'none';
      }
      if (el.tagName === 'INPUT') {
        el.setAttribute('readonly', true);
      }
    });
  }
}

function cancelarEdicao(formId, btn) {
  const form = document.getElementById(formId);
  if (!form) return;
  // Restaura valores originais
  if(formId === 'form-informacoes-pessoais') {
    Array.from(form.elements).forEach(el => {
      if (el.name && valoresOriginaisPF[el.name] !== undefined) el.value = valoresOriginaisPF[el.name];
      if (el.tagName === 'INPUT' || el.tagName === 'SELECT') el.setAttribute('readonly', true);
    });
  } else {
    Array.from(form.elements).forEach(el => {
      if (el.name && valoresOriginaisProf[el.name] !== undefined) el.value = valoresOriginaisProf[el.name];
      // Alterna selects para inputs
      if (el.tagName === 'SELECT' && el.previousElementSibling && el.previousElementSibling.tagName === 'INPUT') {
        el.previousElementSibling.value = el.value;
        el.previousElementSibling.style.display = '';
        el.style.display = 'none';
      }
      if (el.tagName === 'INPUT') {
        el.setAttribute('readonly', true);
      }
    });
  }
  // Desabilita botões Salvar/Cancelar
  const container = form.closest('.container-informacoes');
  if (container) {
    const botoes = container.querySelectorAll('.btn-icone[title="Salvar"], .btn-icone[title="Cancelar"]');
    botoes.forEach(btn => btn.disabled = true);
  }
  document.getElementById('feedback-pf').style.display = 'none';
}

function mostrarFeedbackPF(msg, sucesso) {
  const box = document.getElementById('feedback-pf');
  box.textContent = msg;
  box.style.color = sucesso ? '#008000' : '#b30000';
  box.style.display = 'block';
}

function habilitarEdicaoProfissionais() {
  habilitarEdicao('formProfissionais');
  // Dispara o evento change para garantir exibição correta dos campos
  document.getElementById('instituicao').dispatchEvent(new Event('change'));
}

// --- INÍCIO: Lógica dinâmica para Dados Profissionais (DER/SP) ---
// Esta lógica foi movida para o arquivo JS separado para evitar conflitos
// --- FIM: Lógica dinâmica para Dados Profissionais ---

// Script para o bloco de status de sessão
window.addEventListener("DOMContentLoaded", function() {
  var tempoRestante = parseInt("{{ tempo_restante|default(0) }}");
  var timerEl = document.getElementById('session-timer');
  function formatarTempo(segundos) {
    var min = Math.floor(segundos/60);
    var seg = segundos%60;
    return (min < 10 ? '0' : '') + min + ':' + (seg < 10 ? '0' : '') + seg;
  }
  function atualizarTimer() {
    if (tempoRestante <= 0) {
      timerEl.textContent = '00:00';
      window.location.href = '/login';
      return;
    }
    timerEl.textContent = formatarTempo(tempoRestante);
    tempoRestante--;
    setTimeout(atualizarTimer, 1000);
  }
  if (timerEl) atualizarTimer();
});
</script>
<script src="/static/js/paineis_usuarios/meus_dados/pn_meus_dados_profissionais.js"></script>
</body>
</html>
